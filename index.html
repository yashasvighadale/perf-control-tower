<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Meta Ads Command Center | Sep 2025 ‚Äì Feb 2026</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#090b10;--s1:#0f1219;--s2:#161b26;--s3:#1e2433;--bdr:#262e3f;--tx:#e4e7ee;--tx2:#8892a6;--tx3:#5a6378;--g:#2dd4a0;--g2:rgba(45,212,160,.1);--g3:rgba(45,212,160,.2);--r:#ef6461;--r2:rgba(239,100,97,.1);--r3:rgba(239,100,97,.2);--y:#f5b731;--y2:rgba(245,183,49,.1);--b:#4e9af5;--b2:rgba(78,154,245,.1);--b3:rgba(78,154,245,.15);--p:#a78bfa;--p2:rgba(167,139,250,.1);--c:#22d3ee;--c2:rgba(34,211,238,.1)}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--tx);font-family:'Outfit',sans-serif;line-height:1.55;font-size:13px}
.mono{font-family:'IBM Plex Mono',monospace}
::-webkit-scrollbar{width:5px;height:5px}::-webkit-scrollbar-track{background:var(--s1)}::-webkit-scrollbar-thumb{background:var(--s3);border-radius:3px}
.dash{max-width:1480px;margin:0 auto;padding:20px 24px 60px}
.hdr{display:flex;justify-content:space-between;align-items:flex-start;gap:16px;margin-bottom:20px;flex-wrap:wrap}
.hdr h1{font-size:24px;font-weight:800;letter-spacing:-.5px}
.hdr .sub{color:var(--tx2);font-size:12px;margin-top:2px}
.filters{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.flt-l{font-size:10px;text-transform:uppercase;letter-spacing:.7px;color:var(--tx3);font-weight:600}
select{background:var(--s2);color:var(--tx);border:1px solid var(--bdr);border-radius:7px;padding:5px 26px 5px 8px;font-family:'Outfit',sans-serif;font-size:11px;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='%238892a6' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 5h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 7px center}
select:hover{border-color:var(--b)}
.kpis{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:8px;margin-bottom:20px}
.kpi{background:var(--s1);border:1px solid var(--bdr);border-radius:9px;padding:12px 14px}
.kpi-l{font-size:9px;text-transform:uppercase;letter-spacing:.7px;color:var(--tx3);font-weight:600;margin-bottom:2px}
.kpi-v{font-size:20px;font-weight:700}
.kpi-s{font-size:9.5px;color:var(--tx2);margin-top:1px}
.sec{margin-bottom:24px}
.sec-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:6px}
.sec-h h2{font-size:15px;font-weight:700}
.card{background:var(--s1);border:1px solid var(--bdr);border-radius:10px;padding:16px;overflow:hidden}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
@media(max-width:860px){.g2,.g3{grid-template-columns:1fr}}
table{width:100%;border-collapse:collapse;font-size:11.5px}
th{text-align:left;padding:7px 8px;font-weight:600;font-size:9.5px;text-transform:uppercase;letter-spacing:.4px;color:var(--tx3);border-bottom:1px solid var(--bdr);white-space:nowrap;position:sticky;top:0;background:var(--s1);z-index:2}
td{padding:7px 8px;border-bottom:1px solid rgba(38,46,63,.4);white-space:nowrap}
tr:last-child td{border-bottom:none}
tr:hover td{background:var(--s2)}
.tbl-w{overflow-x:auto;max-height:420px;overflow-y:auto}
.bdg{display:inline-block;padding:1px 7px;border-radius:4px;font-size:10px;font-weight:600}
.bdg-g{background:var(--g2);color:var(--g)}.bdg-r{background:var(--r2);color:var(--r)}.bdg-y{background:var(--y2);color:var(--y)}.bdg-b{background:var(--b2);color:var(--b)}.bdg-p{background:var(--p2);color:var(--p)}
.ins{display:flex;gap:8px;padding:10px 12px;border-radius:7px;margin-bottom:6px;font-size:12px;align-items:flex-start;line-height:1.5}
.ins-w{background:var(--g2);border-left:3px solid var(--g)}.ins-l{background:var(--r2);border-left:3px solid var(--r)}.ins-n{background:var(--b2);border-left:3px solid var(--b)}.ins-y{background:var(--y2);border-left:3px solid var(--y)}
.ins-ic{font-size:13px;flex-shrink:0;margin-top:1px}
.vrd{display:inline-block;padding:3px 9px;border-radius:5px;font-weight:600;font-size:10px}
.vrd-best{background:var(--g2);color:var(--g);border:1px solid var(--g3)}.vrd-worst{background:var(--r2);color:var(--r);border:1px solid var(--r3)}
.tabs{display:flex;gap:0;border-bottom:1px solid var(--bdr);margin-bottom:12px;overflow-x:auto}
.tab{padding:7px 14px;font-size:11px;font-weight:500;color:var(--tx3);cursor:pointer;border-bottom:2px solid transparent;white-space:nowrap;transition:all .15s}
.tab:hover{color:var(--tx2)}.tab.active{color:var(--b);border-bottom-color:var(--b)}
.tab-c{display:none}.tab-c.active{display:block}
.div{height:1px;background:var(--bdr);margin:24px 0}
.fnl{border-top:3px solid var(--bdr)}.fnl.tof{border-top-color:var(--b)}.fnl.mof{border-top-color:var(--g)}.fnl.bof{border-top-color:var(--p)}
.bar-row{display:flex;align-items:center;gap:6px;margin:2px 0}
.bar-fill{height:6px;border-radius:3px;min-width:1px;transition:width .3s}
.saving-box{background:linear-gradient(135deg,var(--g2),var(--b2));border:1px solid var(--g3);border-radius:12px;padding:20px}
.tag{display:inline-block;padding:2px 8px;border-radius:12px;font-size:10px;font-weight:500;margin:1px 2px;background:var(--s3);color:var(--tx2)}
.tag-g{background:var(--g2);color:var(--g)}.tag-r{background:var(--r2);color:var(--r)}
.chart-bars{display:flex;align-items:flex-end;gap:3px;height:140px;padding:0 4px}
.chart-col{display:flex;flex-direction:column;align-items:center;flex:1;gap:2px}
.chart-b{width:100%;border-radius:3px 3px 0 0;min-height:2px;transition:height .4s;cursor:pointer;position:relative}
.chart-b:hover{filter:brightness(1.3)}
.chart-xl{font-size:8px;color:var(--tx3);writing-mode:vertical-rl;transform:rotate(180deg);height:36px;overflow:hidden;text-overflow:ellipsis}
.chart-vl{font-size:8px;color:var(--tx2);margin-bottom:2px;white-space:nowrap}
.exec-box{background:linear-gradient(135deg,rgba(78,154,245,.06),rgba(167,139,250,.06));border:1px solid rgba(78,154,245,.15);border-radius:14px;padding:22px;margin-bottom:20px}
/* ‚îÄ‚îÄ Settings Modal ‚îÄ‚îÄ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(4px)}
.modal{background:var(--s1);border:1px solid var(--bdr);border-radius:16px;padding:28px 32px;width:560px;max-width:95vw;max-height:90vh;overflow-y:auto}
.modal h2{font-size:17px;font-weight:700;margin-bottom:6px}
.modal-sub{font-size:11px;color:var(--tx2);margin-bottom:22px;line-height:1.6}
.field{margin-bottom:16px}
.field label{display:block;font-size:10px;text-transform:uppercase;letter-spacing:.7px;color:var(--tx3);font-weight:600;margin-bottom:6px}
.field input[type=text],.field input[type=date]{width:100%;background:var(--s2);color:var(--tx);border:1px solid var(--bdr);border-radius:7px;padding:8px 12px;font-family:'Outfit',sans-serif;font-size:12px;box-sizing:border-box}
.field input:focus{border-color:var(--b);outline:none}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.field-hint{margin-top:4px;font-size:10px;color:var(--tx3)}
.btn-primary{background:var(--b);color:#fff;border:none;border-radius:8px;padding:9px 22px;font-size:12px;font-weight:600;cursor:pointer;transition:opacity .15s}
.btn-primary:hover{opacity:.85}
.btn-ghost{background:transparent;color:var(--tx2);border:1px solid var(--bdr);border-radius:8px;padding:9px 18px;font-size:12px;cursor:pointer}
.btn-ghost:hover{border-color:var(--b);color:var(--tx)}
.modal-footer{display:flex;gap:10px;justify-content:flex-end;margin-top:24px;border-top:1px solid var(--bdr);padding-top:16px}
/* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
.loading-overlay{position:fixed;inset:0;background:rgba(9,11,16,.88);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;gap:16px}
.spinner{width:40px;height:40px;border:3px solid var(--s3);border-top-color:var(--b);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-msg{font-size:13px;color:var(--tx2)}
/* ‚îÄ‚îÄ Header extras ‚îÄ‚îÄ */
.btn-settings{background:var(--s2);border:1px solid var(--bdr);color:var(--tx2);border-radius:8px;padding:6px 12px;font-size:11px;cursor:pointer;display:inline-flex;align-items:center;gap:5px}
.btn-settings:hover{border-color:var(--b);color:var(--tx)}
.btn-refresh{background:var(--s2);border:1px solid var(--bdr);color:var(--tx2);border-radius:8px;padding:6px 12px;font-size:11px;cursor:pointer}
.btn-refresh:hover{border-color:var(--g);color:var(--g)}
.status-dot{width:7px;height:7px;border-radius:50%;background:var(--g);display:inline-block;margin-right:5px;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}
/* ‚îÄ‚îÄ Setup / Error ‚îÄ‚îÄ */
.setup-prompt{text-align:center;padding:100px 20px;color:var(--tx2)}
.setup-prompt h2{font-size:20px;color:var(--tx);margin-bottom:10px;font-weight:700}
.error-banner{background:var(--r2);border:1px solid var(--r3);border-radius:8px;padding:10px 16px;font-size:12px;color:var(--r);margin-bottom:16px;display:flex;align-items:center;gap:8px}
.fetch-error{position:fixed;top:16px;left:50%;transform:translateX(-50%);z-index:998;min-width:340px;max-width:600px;box-shadow:0 4px 24px rgba(0,0,0,.4)}
</style>
</head>
<body>
<div class="dash" id="app"></div>
<script>
let DATA = {ads:[], monthly:[], weekly:[]};

// UTILITIES
const fmt=n=>!n||isNaN(n)?'‚Çπ0':n>=100000?'‚Çπ'+(n/100000).toFixed(1)+'L':n>=1000?'‚Çπ'+(n/1000).toFixed(1)+'K':'‚Çπ'+Math.round(n);
const fN=n=>!n?'0':n>=100000?(n/100000).toFixed(1)+'L':n>=1000?(n/1000).toFixed(1)+'K':Math.round(n).toLocaleString();
const pct=n=>(n||0).toFixed(2)+'%';
const inr=n=>'‚Çπ'+(n||0).toFixed(2);

function groupBy(a,k){const m={};a.forEach(x=>{const v=x[k]||'Unknown';(m[v]=m[v]||[]).push(x)});return m}

function dimStats(ads,key){
  const g=groupBy(ads,key);
  return Object.entries(g).map(([v,items])=>{
    const sp=items.reduce((s,a)=>s+(a.spend||0),0);
    const cl=items.reduce((s,a)=>s+(a.clicks||0),0);
    const im=items.reduce((s,a)=>s+(a.impressions||0),0);
    const ctrs=items.filter(a=>a.ctr>0).map(a=>a.ctr);
    const ac=ctrs.length?ctrs.reduce((s,v)=>s+v,0)/ctrs.length:0;
    return{val:v,count:items.length,avgCtr:ac,blendCtr:im>0?cl/im*100:0,blendCpc:cl>0?sp/cl:0,cpv:im>0?sp/im:0,spend:sp,clicks:cl,impr:im};
  }).sort((a,b)=>b.avgCtr-a.avgCtr);
}

let curProd='All',curFun='All';
function getAds(){
  let a=DATA.ads;
  if(curProd!=='All')a=a.filter(x=>x.product===curProd);
  if(curFun!=='All')a=a.filter(x=>x.funnel===curFun);
  return a;
}

// RENDER HELPERS
function kpis(ads){
  const sp=ads.reduce((s,a)=>s+a.spend,0),cl=ads.reduce((s,a)=>s+a.clicks,0),im=ads.reduce((s,a)=>s+a.impressions,0);
  const ac=ads.filter(a=>a.ctr>0),avgC=ac.length?ac.reduce((s,a)=>s+a.ctr,0)/ac.length:0;
  const best=[...ads].sort((a,b)=>b.ctr-a.ctr)[0];
  return`<div class="kpis">
    <div class="kpi"><div class="kpi-l">Total Ads</div><div class="kpi-v">${ads.length}</div><div class="kpi-s">${curProd==='All'?'All products':curProd}</div></div>
    <div class="kpi"><div class="kpi-l">Total Spend</div><div class="kpi-v mono">${fmt(sp)}</div><div class="kpi-s">${fN(cl)} clicks</div></div>
    <div class="kpi"><div class="kpi-l">Impressions</div><div class="kpi-v mono">${fN(im)}</div></div>
    <div class="kpi"><div class="kpi-l">Avg CTR</div><div class="kpi-v" style="color:var(--g)">${pct(avgC)}</div><div class="kpi-s">Blended: ${pct(im>0?cl/im*100:0)}</div></div>
    <div class="kpi"><div class="kpi-l">Blended CPC</div><div class="kpi-v mono" style="color:var(--y)">${inr(cl>0?sp/cl:0)}</div></div>
    <div class="kpi"><div class="kpi-l">CPV</div><div class="kpi-v mono">${inr(im>0?sp/im:0)}</div></div>
    <div class="kpi"><div class="kpi-l">Best Ad</div><div class="kpi-v" style="color:var(--g);font-size:16px">${best?best.ad_code:'‚Äì'}</div><div class="kpi-s">${best?pct(best.ctr)+' CTR':''}</div></div>
  </div>`;
}

function dimTable(ads,key,label,showV){
  const st=dimStats(ads,key).filter(s=>s.val!=='Unknown'||s.count>2);
  const gA=ads.filter(a=>a.ctr>0);const gAvg=gA.length?gA.reduce((s,a)=>s+a.ctr,0)/gA.length:1;
  const gCpc=ads.reduce((s,a)=>s+a.spend,0)/(ads.reduce((s,a)=>s+a.clicks,0)||1);
  const mx=Math.max(...st.map(s=>s.avgCtr),0.01);
  const rows=st.map((s,i)=>{
    const cc=s.avgCtr>gAvg*1.15?'var(--g)':s.avgCtr<gAvg*.85?'var(--r)':'var(--tx)';
    const pc=s.blendCpc<gCpc*.85?'var(--g)':s.blendCpc>gCpc*1.15?'var(--r)':'var(--tx)';
    const bw=(s.avgCtr/mx*100).toFixed(0);
    const bc=s.avgCtr>gAvg*1.1?'var(--g)':s.avgCtr<gAvg*.9?'var(--r)':'var(--y)';
    let v='';
    if(showV&&i===0&&st.length>1)v='<span class="vrd vrd-best">üèÜ BEST</span>';
    else if(showV&&i===st.length-1&&st.length>2)v='<span class="vrd vrd-worst">‚õî WORST</span>';
    return`<tr><td style="font-weight:600;max-width:180px;overflow:hidden;text-overflow:ellipsis">${s.val}</td><td>${s.count}</td><td class="mono" style="color:${cc}">${pct(s.avgCtr)}</td><td><div class="bar-row"><div class="bar-fill" style="width:${bw}%;background:${bc}"></div></div></td><td class="mono" style="color:${pc}">${inr(s.blendCpc)}</td><td class="mono">${fmt(s.spend)}</td>${showV?'<td>'+v+'</td>':''}</tr>`;
  }).join('');
  return`<div class="card"><h3 style="font-size:12px;color:var(--tx2);margin-bottom:8px;font-weight:600">${label}</h3><div class="tbl-w"><table><thead><tr><th>${label}</th><th>#</th><th>Avg CTR</th><th>Bar</th><th>Blend CPC</th><th>Spend</th>${showV?'<th>Verdict</th>':''}</tr></thead><tbody>${rows}</tbody></table></div></div>`;
}

function barChart(items,valKey,labelKey,title,colorFn){
  const mx=Math.max(...items.map(i=>i[valKey]||0),0.01);
  const bars=items.map(i=>{
    const h=((i[valKey]||0)/mx*125).toFixed(0);
    const c=colorFn?colorFn(i):'var(--b)';
    return`<div class="chart-col"><div class="chart-vl">${typeof i[valKey]==='number'&&valKey.includes('roas')?i[valKey].toFixed(2)+'x':valKey.includes('cpc')?inr(i[valKey]):fmt(i[valKey])}</div><div class="chart-b" style="height:${h}px;background:${c}"></div><div class="chart-xl">${i[labelKey]}</div></div>`;
  }).join('');
  return`<div class="card"><h3 style="font-size:11px;color:var(--tx2);margin-bottom:8px;font-weight:600">${title}</h3><div class="chart-bars">${bars}</div></div>`;
}

function monthlyCharts(){
  const m=DATA.monthly;
  return`<div class="g3">
    ${barChart(m,'spend','month','Monthly Spend',()=>'var(--b)')}
    ${barChart(m,'cpc','month','Monthly CPC',i=>i.cpc<10?'var(--g)':i.cpc<12?'var(--y)':'var(--r)')}
    ${barChart(m,'roas','month','Monthly ROAS',i=>i.roas>3?'var(--g)':i.roas>2.5?'var(--y)':'var(--r)')}
  </div>`;
}

function weeklyTable(){
  const w=DATA.weekly.slice(-12);
  const rows=w.map(r=>{
    const c=r.cpc<10?'var(--g)':r.cpc<13?'var(--y)':'var(--r)';
    return`<tr><td class="mono">${r.week}</td><td class="mono">${fmt(r.spend)}</td><td class="mono">${fN(r.clicks)}</td><td class="mono" style="color:${c}">${inr(r.cpc)}</td><td>${r.ads_count}</td></tr>`;
  }).join('');
  return`<div class="card"><h3 style="font-size:11px;color:var(--tx2);margin-bottom:8px;font-weight:600">Weekly Performance (Last 12 Weeks)</h3><div class="tbl-w"><table><thead><tr><th>Week</th><th>Spend</th><th>Clicks</th><th>CPC</th><th># Ads</th></tr></thead><tbody>${rows}</tbody></table></div></div>`;
}

function funnelCards(ads){
  const fs=[{k:'TOF',l:'TOF ‚Äì Top of Funnel',c:'tof',clr:'var(--b)'},{k:'MOF',l:'MOF ‚Äì Middle of Funnel',c:'mof',clr:'var(--g)'},{k:'BOF',l:'BOF ‚Äì Bottom of Funnel',c:'bof',clr:'var(--p)'}];
  return fs.map(f=>{
    const it=ads.filter(a=>a.funnel===f.k);if(!it.length)return'';
    const sp=it.reduce((s,a)=>s+a.spend,0),cl=it.reduce((s,a)=>s+a.clicks,0),im=it.reduce((s,a)=>s+a.impressions,0);
    const ac=it.filter(a=>a.ctr>0);const avg=ac.length?ac.reduce((s,a)=>s+a.ctr,0)/ac.length:0;
    const tf=dimStats(it,'format').slice(0,3);
    const th=dimStats(it,'hook').slice(0,2);
    return`<div class="card fnl ${f.c}"><h3 style="color:${f.clr};font-size:12px;font-weight:700;margin-bottom:2px">${f.l}</h3>
    <div style="font-size:11px;color:var(--tx3);margin-bottom:10px">${it.length} ads ¬∑ ${fmt(sp)} spend</div>
    <div style="display:flex;gap:16px;margin-bottom:10px;flex-wrap:wrap">
      <div><div class="kpi-l">Avg CTR</div><div class="mono" style="font-size:16px">${pct(avg)}</div></div>
      <div><div class="kpi-l">Blend CPC</div><div class="mono" style="font-size:16px">${inr(cl>0?sp/cl:0)}</div></div>
      <div><div class="kpi-l">Impressions</div><div class="mono" style="font-size:16px">${fN(im)}</div></div>
    </div>
    <div style="font-size:9px;color:var(--tx3);margin-bottom:3px">TOP FORMATS</div>
    ${tf.map(t=>`<span class="tag">${t.val} (${pct(t.avgCtr)})</span>`).join('')}
    <div style="font-size:9px;color:var(--tx3);margin:6px 0 3px">TOP HOOKS</div>
    ${th.map(t=>`<span class="tag">${t.val} (${pct(t.avgCtr)})</span>`).join('')}
    </div>`;
  }).join('');
}

function topBottom(ads){
  const s=[...ads].filter(a=>a.ctr>0).sort((a,b)=>b.ctr-a.ctr);
  const t5=s.slice(0,5),b5=s.slice(-5).reverse();
  const rr=(list,top)=>list.map(a=>{
    const c=top?'var(--g)':'var(--r)';
    return`<tr><td style="font-weight:600">${a.ad_code}</td><td class="mono" style="color:${c}">${pct(a.ctr)}</td><td class="mono">${inr(a.cpc)}</td><td>${a.format}</td><td>${a.visual_style}</td><td><span class="bdg bdg-b">${a.funnel}</span></td><td>${a.product}</td></tr>`;
  }).join('');
  return`<div class="g2">
    <div class="card" style="border-top:3px solid var(--g)"><h3 style="color:var(--g);font-size:12px;font-weight:700;margin-bottom:8px">üèÜ Top 5 Ads</h3><div class="tbl-w"><table><thead><tr><th>Ad</th><th>CTR</th><th>CPC</th><th>Format</th><th>Style</th><th>Funnel</th><th>Product</th></tr></thead><tbody>${rr(t5,true)}</tbody></table></div>
    <div style="margin-top:8px;font-size:10px;color:var(--tx3)">WINNING DNA:</div><div style="margin-top:4px">${traits(t5,true)}</div></div>
    <div class="card" style="border-top:3px solid var(--r)"><h3 style="color:var(--r);font-size:12px;font-weight:700;margin-bottom:8px">‚õî Bottom 5 Ads</h3><div class="tbl-w"><table><thead><tr><th>Ad</th><th>CTR</th><th>CPC</th><th>Format</th><th>Style</th><th>Funnel</th><th>Product</th></tr></thead><tbody>${rr(b5,false)}</tbody></table></div>
    <div style="margin-top:8px;font-size:10px;color:var(--tx3)">LOSING DNA:</div><div style="margin-top:4px">${traits(b5,false)}</div></div>
  </div>`;
}

function traits(ads,win){
  const c=win?'tag-g':'tag-r';
  const ds=['format','visual_style','hook','tone','vo','narrative','funnel','product'];
  let tags=[];
  ds.forEach(d=>{
    const m={};ads.forEach(a=>{const v=a[d]||'?';m[v]=(m[v]||0)+1});
    const t=Object.entries(m).sort((a,b)=>b[1]-a[1])[0];
    if(t&&t[1]>=2)tags.push(`<span class="tag ${c}">${t[0]} (${t[1]}/${ads.length})</span>`);
  });
  return tags.join('')||'<span class="tag">Mixed</span>';
}

function crossAnalysis(ads){
  const combos={};
  ads.forEach(a=>{
    if(a.format==='Unknown'||a.visual_style==='Unknown')return;
    const k=a.format+'|'+a.visual_style;
    (combos[k]=combos[k]||[]).push(a);
  });
  let rows=Object.entries(combos).filter(([,v])=>v.length>=2).map(([k,items])=>{
    const[f,s]=k.split('|');
    const ac=items.filter(a=>a.ctr>0).map(a=>a.ctr);
    const avg=ac.length?ac.reduce((a,b)=>a+b,0)/ac.length:0;
    const sp=items.reduce((a,b)=>a+b.spend,0);
    const cl=items.reduce((a,b)=>a+b.clicks,0);
    return{f,s,n:items.length,avg,cpc:cl>0?sp/cl:0,sp};
  }).sort((a,b)=>b.avg-a.avg);
  
  // Hook x Tone
  const ht={};
  ads.forEach(a=>{
    if(a.hook==='Unknown'||a.tone==='Unknown')return;
    const k=a.hook+'|'+a.tone;
    (ht[k]=ht[k]||[]).push(a);
  });
  let htRows=Object.entries(ht).filter(([,v])=>v.length>=2).map(([k,items])=>{
    const[h,t]=k.split('|');
    const ac=items.filter(a=>a.ctr>0).map(a=>a.ctr);
    const avg=ac.length?ac.reduce((a,b)=>a+b,0)/ac.length:0;
    const sp=items.reduce((a,b)=>a+b.spend,0);
    const cl=items.reduce((a,b)=>a+b.clicks,0);
    return{h,t,n:items.length,avg,cpc:cl>0?sp/cl:0};
  }).sort((a,b)=>b.avg-a.avg);

  const gA=ads.filter(a=>a.ctr>0);const gAvg=gA.length?gA.reduce((s,a)=>s+a.ctr,0)/gA.length:1;

  const r1=rows.slice(0,10).map(r=>{
    const c=r.avg>gAvg*1.15?'var(--g)':r.avg<gAvg*.85?'var(--r)':'var(--tx)';
    return`<tr><td>${r.f}</td><td>${r.s}</td><td>${r.n}</td><td class="mono" style="color:${c}">${pct(r.avg)}</td><td class="mono">${inr(r.cpc)}</td></tr>`;
  }).join('');
  const r2=htRows.slice(0,10).map(r=>{
    const c=r.avg>gAvg*1.15?'var(--g)':r.avg<gAvg*.85?'var(--r)':'var(--tx)';
    return`<tr><td>${r.h}</td><td>${r.t}</td><td>${r.n}</td><td class="mono" style="color:${c}">${pct(r.avg)}</td><td class="mono">${inr(r.cpc)}</td></tr>`;
  }).join('');

  return`<div class="g2">
    <div class="card"><h3 style="font-size:12px;color:var(--tx2);margin-bottom:8px;font-weight:600">Format √ó Visual Style (min 2 ads)</h3><div class="tbl-w"><table><thead><tr><th>Format</th><th>Visual Style</th><th>#</th><th>Avg CTR</th><th>CPC</th></tr></thead><tbody>${r1}</tbody></table></div></div>
    <div class="card"><h3 style="font-size:12px;color:var(--tx2);margin-bottom:8px;font-weight:600">Hook √ó Emotion/Tone (min 2 ads)</h3><div class="tbl-w"><table><thead><tr><th>Hook</th><th>Tone</th><th>#</th><th>Avg CTR</th><th>CPC</th></tr></thead><tbody>${r2}</tbody></table></div></div>
  </div>`;
}

function fullTable(ads){
  const s=[...ads].sort((a,b)=>b.ctr-a.ctr);
  const rows=s.map(a=>{
    const cc=a.ctr>2.5?'var(--g)':a.ctr>1.5?'var(--y)':'var(--r)';
    const pc=a.cpc<10?'var(--g)':a.cpc<20?'var(--y)':'var(--r)';
    return`<tr><td style="font-weight:600">${a.ad_code}</td><td>${a.product}</td><td><span class="bdg bdg-b">${a.funnel}</span></td><td class="mono" style="color:${cc}">${pct(a.ctr)}</td><td class="mono" style="color:${pc}">${inr(a.cpc)}</td><td class="mono">${fmt(a.spend)}</td><td>${a.format}</td><td>${a.visual_style}</td><td>${a.hook}</td><td>${a.tone}</td><td>${a.narrative}</td><td>${a.vo}</td><td>${a.created_by}</td><td>${a.offer}</td></tr>`;
  }).join('');
  return`<div class="card"><div class="tbl-w" style="max-height:600px"><table><thead><tr><th>Ad</th><th>Product</th><th>Funnel</th><th>CTR</th><th>CPC</th><th>Spend</th><th>Format</th><th>Style</th><th>Hook</th><th>Tone</th><th>Narrative</th><th>VO</th><th>Creator</th><th>Offer</th></tr></thead><tbody>${rows}</tbody></table></div></div>`;
}

function spendFlags(ads){
  const gA=ads.filter(a=>a.ctr>0);const gAvg=gA.length?gA.reduce((s,a)=>s+a.ctr,0)/gA.length:1;
  const gCpc=ads.reduce((s,a)=>s+a.spend,0)/(ads.reduce((s,a)=>s+a.clicks,0)||1);
  const avgSpend=ads.reduce((s,a)=>s+a.spend,0)/ads.length;
  const ineff=ads.filter(a=>a.ctr<gAvg*.7&&a.spend>5000).sort((a,b)=>b.spend-a.spend).slice(0,6);
  const under=ads.filter(a=>a.ctr>gAvg*1.3&&a.cpc<gCpc*.8&&a.spend<avgSpend*.5).sort((a,b)=>b.ctr-a.ctr).slice(0,6);
  const rr=(list,bad)=>list.map(a=>`<div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--bdr);font-size:12px"><div><strong>${a.ad_code}</strong> ¬∑ ${a.product} ¬∑ ${fmt(a.spend)}</div><div><span class="bdg ${bad?'bdg-r':'bdg-g'}">${pct(a.ctr)} CTR</span> <span class="bdg ${bad?'bdg-r':'bdg-g'}">${inr(a.cpc)} CPC</span></div></div>`).join('');
  return`<div class="g2">
    <div class="card" style="border-top:3px solid var(--r)"><h3 style="color:var(--r);font-size:12px;font-weight:700;margin-bottom:8px">üö® High-Spend, Low-Performance</h3>${rr(ineff,true)}<div style="margin-top:8px;font-size:10px;color:var(--tx2)">Total inefficient spend: ${fmt(ineff.reduce((s,a)=>s+a.spend,0))}</div></div>
    <div class="card" style="border-top:3px solid var(--g)"><h3 style="color:var(--g);font-size:12px;font-weight:700;margin-bottom:8px">üöÄ Underspent Winners (Scale These)</h3>${rr(under,false)}<div style="margin-top:8px;font-size:10px;color:var(--tx2)">High CTR + Low CPC but below-average spend</div></div>
  </div>`;
}

function costPlaybook(ads){
  const gA=ads.filter(a=>a.ctr>0);const gAvg=gA.length?gA.reduce((s,a)=>s+a.ctr,0)/gA.length:1;
  const gCpc=ads.reduce((s,a)=>s+a.spend,0)/(ads.reduce((s,a)=>s+a.clicks,0)||1);
  const tSpend=ads.reduce((s,a)=>s+a.spend,0);
  const ineff=ads.filter(a=>a.ctr<gAvg*.7&&a.spend>5000);
  const ineffSp=ineff.reduce((s,a)=>s+a.spend,0);
  
  const fmtS=dimStats(ads,'format').filter(s=>s.val!=='Unknown');
  const best=fmtS[0],worst=fmtS[fmtS.length-1];
  const hookS=dimStats(ads,'hook').filter(s=>s.val!=='Unknown');
  const bestH=hookS[0];
  const voS=dimStats(ads,'vo').filter(s=>s.val!=='Unknown');
  const noVO=voS.find(v=>v.val==='No VO'),yVO=voS.find(v=>v.val==='VO');
  const prodS=dimStats(ads,'product').filter(s=>s.val!=='Unknown');
  const bestP=prodS[0],worstP=prodS[prodS.length-1];
  const brandS=dimStats(ads,'production').find(s=>s.val==='Brand');
  const narS=dimStats(ads,'narrative').filter(s=>s.val!=='Unknown');
  const bestN=narS[0],worstN=narS[narS.length-1];
  
  return`<div class="saving-box">
    <h2 style="margin-bottom:16px;font-size:16px;font-weight:700">üí∞ Cost Optimization & Efficiency Playbook</h2>
    <div class="g2" style="gap:16px;margin-bottom:16px">
      <div>
        <div style="font-size:10px;text-transform:uppercase;letter-spacing:.7px;color:var(--tx3);font-weight:600;margin-bottom:4px">Estimated Recoverable Spend</div>
        <div style="font-size:28px;font-weight:800;color:var(--g)">${fmt(ineffSp)}</div>
        <div style="font-size:11px;color:var(--tx2)">${ineff.length} ads below 70% of avg CTR with >‚Çπ5K spend (${(ineffSp/tSpend*100).toFixed(0)}% of budget)</div>
      </div>
      <div>
        <div style="font-size:10px;text-transform:uppercase;letter-spacing:.7px;color:var(--tx3);font-weight:600;margin-bottom:4px">Projected CPC Improvement</div>
        <div style="font-size:28px;font-weight:800;color:var(--b)">25-40%</div>
        <div style="font-size:11px;color:var(--tx2)">If budget shifts from worst to best performing combinations</div>
      </div>
    </div>
    <div class="div" style="margin:12px 0;background:var(--g3)"></div>
    <h3 style="font-size:13px;font-weight:700;margin-bottom:10px">Strategic Recommendations for Leadership</h3>
    
    <div class="ins ins-w"><span class="ins-ic">1Ô∏è‚É£</span><div><strong>Shift creative mix to GIFs + 15-30s Video:</strong> <strong>${best?best.val:'GIFs'}</strong> delivers ${best?pct(best.avgCtr):'4.23%'} avg CTR at ${best?inr(best.blendCpc):'‚Çπ7.86'} CPC vs <strong>${worst?worst.val:'worst format'}</strong> at ${worst?pct(worst.avgCtr):'1.19%'} / ${worst?inr(worst.blendCpc):'‚Çπ28.47'}. Reallocating 30% of static image budget to motion formats could save ‚Çπ50K-80K/month in wasted clicks.</div></div>
    
    <div class="ins ins-w"><span class="ins-ic">2Ô∏è‚É£</span><div><strong>Fix the Brisk problem:</strong> Brisk is your #1 spend product (${fmt(prodS.find(s=>s.val==='Brisk')?.spend||0)}) but has the lowest blended CTR at ${pct(prodS.find(s=>s.val==='Brisk')?.blendCtr||0)}. Meanwhile <strong>${bestP?bestP.val:'STROM GO'}</strong> achieves ${bestP?pct(bestP.avgCtr):'2.84%'} CTR. Run an A/B test applying STROM GO's winning creative formula (GIF/15-30s + Pain Point hook) to Brisk ads.</div></div>
    
    <div class="ins ins-w"><span class="ins-ic">3Ô∏è‚É£</span><div><strong>Eliminate Voice Over on Meta:</strong> No VO ads cost ${noVO?inr(noVO.blendCpc):'‚Çπ9.60'} per click vs ${yVO?inr(yVO.blendCpc):'‚Çπ11.87'} for VO ‚Äî and VO's blended CTR is only ${yVO?pct(yVO.blendCtr):'0.22%'} vs ${noVO?pct(noVO.blendCtr):'2.18%'} for silent ads. 85%+ of Meta users browse with sound off. <strong>Save on VO production AND get better performance.</strong></div></div>
    
    <div class="ins ins-w"><span class="ins-ic">4Ô∏è‚É£</span><div><strong>Scale "${bestH?bestH.val:'Pain Point Trigger'}" hooks:</strong> ${bestH?pct(bestH.avgCtr):'2.76%'} avg CTR at ${bestH?inr(bestH.blendCpc):'‚Çπ8.75'} CPC. Only ${bestH?bestH.count:7} of ${ads.length} ads use this hook type. Replacing generic/celebrity hooks (which show ${pct(hookS.find(s=>s.val==='celebrity')?.avgCtr||0)} CTR) could improve click efficiency by 3-4x.</div></div>
    
    <div class="ins ins-y"><span class="ins-ic">5Ô∏è‚É£</span><div><strong>Invest in Story Telling + Problem Solution narratives:</strong> "${bestN?bestN.val:'Story Telling'}" delivers ${bestN?pct(bestN.avgCtr):'3.35%'} CTR while "${worstN?worstN.val:'worst narrative'}" shows ${worstN?pct(worstN.avgCtr):'N/A'}. Educational and PR Coverage narratives consistently underperform ‚Äî redirect those creative resources.</div></div>
    
    <div class="ins ins-y"><span class="ins-ic">6Ô∏è‚É£</span><div><strong>ROAS is declining (3.85x Nov ‚Üí 2.14x Feb):</strong> Monthly data shows clear ROAS erosion. This suggests creative fatigue. Implement a 3-week creative refresh cycle and increase creative volume for MOF/BOF where ROAS is typically highest.</div></div>
    
    <div class="ins ins-n"><span class="ins-ic">7Ô∏è‚É£</span><div><strong>Rebalance funnel spend:</strong> TOF has ${dimStats(ads,'funnel').find(s=>s.val==='TOF')?.count||0} ads (68% of creatives) but MOF/BOF where warm audiences convert cheaper are underinvested. Shift 15-20% of TOF budget to MOF retargeting with the winning GIF format.</div></div>
    
    <div class="ins ins-n"><span class="ins-ic">8Ô∏è‚É£</span><div><strong>Creator assignment optimization:</strong> Top creators (by CTR efficiency) should get more volume. Brand in-house production at ${brandS?inr(brandS.blendCpc):'‚Çπ9.89'} CPC is more cost-efficient. Consider an internal "creative war room" with weekly performance reviews to iterate faster on winning formats.</div></div>
  </div>`;
}

// EXECUTIVE SUMMARY
function execSummary(ads){
  const fmtS=dimStats(ads,'format').filter(s=>s.val!=='Unknown');
  const hookS=dimStats(ads,'hook').filter(s=>s.val!=='Unknown');
  const styleS=dimStats(ads,'visual_style').filter(s=>s.val!=='Unknown');
  const prodS=dimStats(ads,'product').filter(s=>s.val!=='Unknown');
  
  return`<div class="exec-box">
    <h2 style="margin-bottom:14px;font-size:16px;font-weight:700">üéØ Executive Summary: What's Working vs. What's Not</h2>
    <div class="g2">
      <div>
        <h3 style="color:var(--g);font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">‚úÖ What's Working</h3>
        <div class="ins ins-w"><span class="ins-ic">üèÜ</span><div><strong>GIFs dominate</strong> ‚Äî 4.23% avg CTR, ‚Çπ7.86 CPC. 2x better than average on both metrics. Your most efficient format.</div></div>
        <div class="ins ins-w"><span class="ins-ic">üé¨</span><div><strong>Video 15-30sec</strong> is the high-scale winner ‚Äî 2.97% CTR with ‚Çπ2.1L spend proving it works at volume.</div></div>
        <div class="ins ins-w"><span class="ins-ic">üéØ</span><div><strong>STROM GO + DRIP</strong> are your star products ‚Äî highest CTR at reasonable CPC.</div></div>
        <div class="ins ins-w"><span class="ins-ic">ü™ù</span><div><strong>Pain Point Triggers + FOMO hooks</strong> crush generic hooks by 1.5-2x on CTR.</div></div>
        <div class="ins ins-w"><span class="ins-ic">üìñ</span><div><strong>Story Telling narrative</strong> ‚Äî 3.35% CTR, best narrative by far when paired with engaging formats.</div></div>
      </div>
      <div>
        <h3 style="color:var(--r);font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">‚ùå What's Not Working</h3>
        <div class="ins ins-l"><span class="ins-ic">üõë</span><div><strong>Video 45-60sec</strong> is dead weight ‚Äî 1.19% CTR, ‚Çπ28.47 CPC. Too long for Meta scroll behavior.</div></div>
        <div class="ins ins-l"><span class="ins-ic">üìâ</span><div><strong>Brisk ads</strong> at 0.41% blended CTR despite 28% of total spend. Massive efficiency leak.</div></div>
        <div class="ins ins-l"><span class="ins-ic">‚ö†Ô∏è</span><div><strong>Celebrity hooks</strong> ‚Äî 0.77% avg CTR, worst performing hook type. Celebrity doesn't equal engagement.</div></div>
        <div class="ins ins-l"><span class="ins-ic">üí∏</span><div><strong>REN BEAM</strong> ‚Äî ‚Çπ22.18 CPC (2x average). Check targeting and creative quality.</div></div>
        <div class="ins ins-l"><span class="ins-ic">üìä</span><div><strong>Educational + Testimonial narratives</strong> consistently bottom-rank. People want solutions, not lectures.</div></div>
      </div>
    </div>
  </div>`;
}

// ============================================================
// MAIN RENDER
// ============================================================
// ============================================================
// CONFIG & STORAGE
// ============================================================
const LS={
  get:k=>localStorage.getItem('macc_'+k)||'',
  set:(k,v)=>localStorage.setItem('macc_'+k,v),
  all:()=>({
    token:    localStorage.getItem('macc_token')||'',
    accountId:localStorage.getItem('macc_accountId')||'',
    csvUrl:   localStorage.getItem('macc_csvUrl')||'',
    startDate:localStorage.getItem('macc_startDate')||'',
    endDate:  localStorage.getItem('macc_endDate')||''
  }),
  hasConfig:()=>!!(localStorage.getItem('macc_token')&&localStorage.getItem('macc_accountId'))
};

// ============================================================
// UTILITY
// ============================================================
function escHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

// ============================================================
// LOADING & ERROR UI
// ============================================================
function showLoading(msg){
  let el=document.getElementById('loading-overlay');
  if(!el){el=document.createElement('div');el.id='loading-overlay';el.className='loading-overlay';document.body.appendChild(el);}
  el.innerHTML=`<div class="spinner"></div><div class="loading-msg" id="loading-msg">${escHtml(msg||'Fetching data‚Ä¶')}</div>`;
}
function updateLoadingMsg(msg){const el=document.getElementById('loading-msg');if(el)el.textContent=msg;}
function hideLoading(){const el=document.getElementById('loading-overlay');if(el)el.remove();}

function showFetchError(msg){
  document.getElementById('fetch-error-banner')?.remove();
  const el=document.createElement('div');
  el.id='fetch-error-banner';el.className='error-banner fetch-error';
  el.innerHTML=`<span>‚ö†</span><span>${escHtml(msg)}</span><button onclick="this.parentElement.remove()" style="margin-left:auto;background:none;border:none;color:inherit;cursor:pointer;font-size:15px">‚úï</button>`;
  document.body.appendChild(el);
  setTimeout(()=>el.remove?.(),10000);
}

function showSetupPrompt(){
  document.getElementById('app').innerHTML=`
    <div class="setup-prompt">
      <div style="font-size:40px;margin-bottom:16px">üìä</div>
      <h2>Welcome to Meta Ads Command Center</h2>
      <p style="margin-bottom:8px;font-size:13px">Connect your Meta Ads account to see live performance data.</p>
      <p style="margin-bottom:28px;font-size:12px;color:var(--tx3)">Your access token is stored only in this browser.</p>
      <button class="btn-primary" onclick="renderSettingsModal()" style="font-size:13px;padding:11px 28px">‚öô Configure Data Sources</button>
    </div>`;
}

// ============================================================
// SETTINGS MODAL
// ============================================================
function renderSettingsModal(){
  document.getElementById('settings-modal')?.remove();
  const cfg=LS.all();
  const canClose=LS.hasConfig();
  const el=document.createElement('div');
  el.className='modal-overlay';el.id='settings-modal';
  el.innerHTML=`
    <div class="modal" role="dialog" aria-modal="true">
      <h2>‚öô Dashboard Settings</h2>
      <div class="modal-sub">Configure your data sources. Your Meta token is stored only in this browser's localStorage ‚Äî it never leaves your device.</div>
      <div id="cfg-error" class="error-banner" style="display:none"><span>‚ö†</span><span id="cfg-error-msg"></span></div>
      <div class="field">
        <label>Meta Access Token</label>
        <input id="cfg-token" type="text" placeholder="EAABsbCS‚Ä¶" value="${escHtml(cfg.token)}" autocomplete="off" spellcheck="false"/>
        <div class="field-hint">Get from: Meta Business Suite ‚Üí Settings ‚Üí System Users ‚Üí Generate Token (needs <code>ads_read</code> + <code>read_insights</code>)</div>
      </div>
      <div class="field">
        <label>Ad Account ID</label>
        <input id="cfg-accountId" type="text" placeholder="123456789" value="${escHtml(cfg.accountId)}"/>
        <div class="field-hint">Numbers only ‚Äî no "act_" prefix. Found in the Ads Manager URL.</div>
      </div>
      <div class="field">
        <label>Google Sheet CSV URL <span style="color:var(--tx3);font-weight:400">(optional ‚Äî for creative labels)</span></label>
        <input id="cfg-csvUrl" type="text" placeholder="https://docs.google.com/spreadsheets/d/‚Ä¶/pub?output=csv" value="${escHtml(cfg.csvUrl)}"/>
        <div class="field-hint">File ‚Üí Share ‚Üí Publish to web ‚Üí select sheet ‚Üí CSV. Sheet must have an <code>ad_code</code> column matching your Meta ad names.</div>
      </div>
      <div class="field">
        <label>Date Range</label>
        <div class="field-row">
          <div><div class="field-hint" style="margin-bottom:5px">Start Date</div><input id="cfg-start" type="date" value="${escHtml(cfg.startDate)}"/></div>
          <div><div class="field-hint" style="margin-bottom:5px">End Date</div><input id="cfg-end" type="date" value="${escHtml(cfg.endDate)}"/></div>
        </div>
        <div class="field-hint">Leave blank to use the last 90 days.</div>
      </div>
      <div class="modal-footer">
        ${canClose?`<button class="btn-ghost" onclick="closeSettings()">Cancel</button>`:''}
        <button class="btn-primary" onclick="saveSettings()">Save & Load Data</button>
      </div>
    </div>`;
  if(canClose) el.addEventListener('click',e=>{if(e.target===el)closeSettings();});
  document.body.appendChild(el);
  setTimeout(()=>document.getElementById('cfg-token')?.focus(),50);
}

function closeSettings(){document.getElementById('settings-modal')?.remove();}

function showCfgError(msg){
  const b=document.getElementById('cfg-error'),m=document.getElementById('cfg-error-msg');
  if(b&&m){m.textContent=msg;b.style.display='flex';}
}

function saveSettings(){
  const token    =document.getElementById('cfg-token').value.trim();
  const accountId=document.getElementById('cfg-accountId').value.trim();
  const csvUrl   =document.getElementById('cfg-csvUrl').value.trim();
  const startDate=document.getElementById('cfg-start').value;
  const endDate  =document.getElementById('cfg-end').value;
  if(!token)     return showCfgError('Meta Access Token is required.');
  if(!accountId) return showCfgError('Ad Account ID is required.');
  if(!/^\d+$/.test(accountId)) return showCfgError('Ad Account ID must be numeric only (no "act_" prefix).');
  if(csvUrl&&!csvUrl.startsWith('https://docs.google.com/')) return showCfgError('CSV URL must be a Google Sheets published link.');
  if(startDate&&endDate&&startDate>endDate) return showCfgError('Start date must be before end date.');
  LS.set('token',token);LS.set('accountId',accountId);LS.set('csvUrl',csvUrl);
  LS.set('startDate',startDate);LS.set('endDate',endDate);
  closeSettings();
  initDashboard();
}

// ============================================================
// META GRAPH API
// ============================================================
async function metaPaginateAll(url){
  const all=[];let next=url;let page=0;
  while(next&&page<20){
    updateLoadingMsg(`Fetching Meta data‚Ä¶ (page ${page+1})`);
    const res=await fetch(next);
    const json=await res.json();
    if(json.error) throw new Error('Meta API: '+json.error.message);
    if(Array.isArray(json.data)) all.push(...json.data);
    next=json.paging?.next||null;
    page++;
  }
  return all;
}

async function fetchMetaInsights(token,accountId,startDate,endDate){
  const base=`https://graph.facebook.com/v21.0/act_${accountId}/insights`;
  const tok=encodeURIComponent(token);
  const dateParam=(startDate&&endDate)
    ?`&time_range=${encodeURIComponent(JSON.stringify({since:startDate,until:endDate}))}`
    :'&date_preset=last_90d';

  // Ad-level (paginated)
  const adsUrl=`${base}?access_token=${tok}&fields=${encodeURIComponent('ad_id,ad_name,impressions,spend,clicks,cpc,ctr,cpp,reach,frequency')}&level=ad&limit=500${dateParam}`;
  updateLoadingMsg('Fetching ad-level insights from Meta‚Ä¶');
  const adsRaw=await metaPaginateAll(adsUrl);

  // Monthly
  const mFields=encodeURIComponent('impressions,spend,clicks,cpc,date_start,date_stop');
  const monthlyUrl=`${base}?access_token=${tok}&fields=${mFields}&level=account&time_increment=monthly&limit=36${dateParam}`;
  updateLoadingMsg('Fetching monthly breakdown‚Ä¶');
  const monthlyRaw=await metaPaginateAll(monthlyUrl);

  // Weekly
  const weeklyUrl=`${base}?access_token=${tok}&fields=${mFields}&level=account&time_increment=7&limit=52${dateParam}`;
  updateLoadingMsg('Fetching weekly breakdown‚Ä¶');
  const weeklyRaw=await metaPaginateAll(weeklyUrl);

  return{adsRaw,monthlyRaw,weeklyRaw};
}

// ============================================================
// GOOGLE SHEETS CSV
// ============================================================
function parseCsv(text){
  const lines=text.trim().split(/\r?\n/);
  if(lines.length<2)return[];
  function parseRow(line){
    const r=[];let cur='';let inQ=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c==='"'){if(inQ&&line[i+1]==='"'){cur+='"';i++;}else inQ=!inQ;}
      else if(c===','&&!inQ){r.push(cur.trim());cur='';}
      else cur+=c;
    }
    r.push(cur.trim());return r;
  }
  const headers=parseRow(lines[0]).map(h=>h.toLowerCase().trim());
  const rows=[];
  for(let i=1;i<lines.length;i++){
    const vals=parseRow(lines[i]);
    if(vals.every(v=>!v))continue;
    const row={};headers.forEach((h,idx)=>{row[h]=vals[idx]||'';});
    rows.push(row);
  }
  return rows;
}

async function fetchSheetData(csvUrl){
  if(!csvUrl)return[];
  updateLoadingMsg('Fetching creative taxonomy from Google Sheets‚Ä¶');
  const url=csvUrl+(csvUrl.includes('?')?'&':'?')+'_t='+Date.now();
  const res=await fetch(url,{cache:'no-store'});
  if(!res.ok)throw new Error(`Google Sheets fetch failed (HTTP ${res.status}). Check your CSV URL.`);
  const text=await res.text();
  if(text.trim().startsWith('<'))throw new Error('Google Sheets returned HTML. Make sure the sheet is published as CSV (File ‚Üí Share ‚Üí Publish to web).');
  return parseCsv(text);
}

// ============================================================
// DATA MERGE
// ============================================================
const TAXONOMY_DEFAULTS={visual_style:'Unknown',hook:'Unknown',tone:'Unknown',narrative:'Unknown',vo:'Unknown',production:'Unknown',format:'Unknown',funnel:'Unknown',product:'Unknown',created_by:'Unknown',offer:'Unknown',prices:'Unknown',rtb:'',starring:'',language:'',season:''};

function normalizeMetaAd(raw){
  var adName=(raw.ad_name||'').trim();
  var match=adName.match(/NK-\d+/i);
  return{
    ad_id:raw.ad_id||'',
    ad_code:match?match[0].toUpperCase():adName,
    ad_name:adName,
    spend:parseFloat(raw.spend)||0,
    clicks:parseInt(raw.clicks)||0,
    impressions:parseInt(raw.impressions)||0,
    ctr:parseFloat(raw.ctr)||0,
    cpc:parseFloat(raw.cpc)||0,
    cpp:parseFloat(raw.cpp)||0,
    reach:parseInt(raw.reach)||0,
    frequency:parseFloat(raw.frequency)||0,
    cpv:0
  };
}

function mergeData(metaAds,sheetRows){
  const map={};
  sheetRows.forEach(r=>{const k=(r.ad_code||'').trim();if(k)map[k]=r;});
  return metaAds.map(raw=>{
    const meta=normalizeMetaAd(raw);
    const sheet=map[meta.ad_code]||{};
    return{...TAXONOMY_DEFAULTS,...sheet,...meta,ad_code:meta.ad_code};
  });
}

function buildMonthlyData(raw){
  return raw.map(r=>{
    const spend=parseFloat(r.spend)||0,clicks=parseInt(r.clicks)||0;
    const d=new Date(r.date_start);
    const month=d.toLocaleString('en',{month:'short'})+" '"+String(d.getFullYear()).slice(2);
    return{month,spend,cpc:parseFloat(r.cpc)||(clicks>0?spend/clicks:0),roas:0};
  });
}

function buildWeeklyData(raw){
  return raw.map(r=>{
    const spend=parseFloat(r.spend)||0,clicks=parseInt(r.clicks)||0;
    const d=new Date(r.date_start);
    const week=d.toLocaleString('en',{month:'short'})+' '+d.getDate();
    return{week,spend,clicks,cpc:parseFloat(r.cpc)||(clicks>0?spend/clicks:0),ads_count:0};
  });
}

// ============================================================
// ORCHESTRATOR
// ============================================================
async function initDashboard(){
  if(!LS.hasConfig()){showSetupPrompt();return;}
  const cfg=LS.all();
  showLoading('Connecting to Meta Ads API‚Ä¶');
  try{
    const[metaResult,sheetRows]=await Promise.all([
      fetchMetaInsights(cfg.token,cfg.accountId,cfg.startDate,cfg.endDate),
      fetchSheetData(cfg.csvUrl).catch(err=>{
        showFetchError('Google Sheets: '+err.message+' Creative labels will show as "Unknown".');
        return[];
      })
    ]);
    const{adsRaw,monthlyRaw,weeklyRaw}=metaResult;
    updateLoadingMsg('Merging data‚Ä¶');
    DATA.ads=mergeData(adsRaw,sheetRows);
    DATA.monthly=buildMonthlyData(monthlyRaw);
    DATA.weekly=buildWeeklyData(weeklyRaw);
    hideLoading();
    if(DATA.ads.length===0){showFetchError('No ads found for the selected date range. Try expanding the range in Settings.');}
    render();
  }catch(err){
    hideLoading();
    const isAuth=/token|auth|permission|OAuthException|Invalid OAuth/i.test(err.message);
    if(isAuth){
      document.getElementById('app').innerHTML=`
        <div class="setup-prompt">
          <div style="font-size:40px;margin-bottom:16px">üîê</div>
          <h2 style="color:var(--r)">Authentication Failed</h2>
          <p style="margin-bottom:8px;font-size:12px;color:var(--tx2)">${escHtml(err.message)}</p>
          <p style="margin-bottom:24px;font-size:12px;color:var(--tx3)">Your Meta token may be expired or missing <code>ads_read</code> permission.</p>
          <button class="btn-primary" onclick="renderSettingsModal()">Update Token</button>
        </div>`;
    }else{
      showFetchError(err.message);
      if(DATA.ads.length>0)render();else showSetupPrompt();
    }
  }
}

// ============================================================
function render(){
  const ads=getAds();
  const products=['All',...new Set(DATA.ads.map(a=>a.product).filter(p=>p&&p!=='Unknown'))].sort((a,b)=>a==='All'?-1:b==='All'?1:a.localeCompare(b));
  const funnels=['All','TOF','MOF','BOF'];
  
  document.getElementById('app').innerHTML=`
    <div class="hdr">
      <div>
        <h1>Meta Ads Performance Command Center</h1>
        <div class="sub"><span class="status-dot"></span>${DATA.ads.length} ads ¬∑ ${escHtml(LS.get('startDate')||'last 90 days')} ‚Äì ${escHtml(LS.get('endDate')||'today')} ¬∑ Live data ¬∑ All values in INR</div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <div class="filters">
          <span class="flt-l">Product:</span>
          <select id="fp">${products.map(p=>`<option value="${p}" ${p===curProd?'selected':''}>${p}</option>`).join('')}</select>
          <span class="flt-l" style="margin-left:8px">Funnel:</span>
          <select id="ff">${funnels.map(f=>`<option value="${f}" ${f===curFun?'selected':''}>${f}</option>`).join('')}</select>
        </div>
        <button class="btn-refresh" onclick="initDashboard()">‚Ü∫ Refresh</button>
        <button class="btn-settings" onclick="renderSettingsModal()">‚öô Settings</button>
      </div>
    </div>
    
    ${kpis(ads)}
    ${execSummary(ads)}
    
    <div class="sec"><div class="sec-h"><h2>üìà Monthly & Weekly Trends</h2></div>${monthlyCharts()}<div style="margin-top:10px">${weeklyTable()}</div></div>
    <div class="div"></div>
    
    <div class="sec"><div class="sec-h"><h2>üì¶ Product Performance</h2></div>
    <div class="g2">
      ${barChart(dimStats(ads,'product').filter(s=>s.val!=='Unknown'),'avgCtr','val','Product Avg CTR',i=>i.avgCtr>2.5?'var(--g)':i.avgCtr>1.8?'var(--b)':i.avgCtr>1.3?'var(--y)':'var(--r)')}
      ${dimTable(ads,'product','Product',true)}
    </div></div>
    <div class="div"></div>
    
    <div class="sec"><div class="sec-h"><h2>üîΩ Funnel Level Analysis</h2></div><div class="g3">${funnelCards(ads)}</div></div>
    <div class="div"></div>
    
    <div class="sec"><div class="sec-h"><h2>üìê Creative Format Performance</h2></div>${dimTable(ads,'format','Creative Format',true)}</div>
    
    <div class="sec"><div class="sec-h"><h2>üé® Visual Style Performance</h2></div>
    <div class="g2">${dimTable(ads,'visual_style','Visual Style',true)}${barChart(dimStats(ads,'visual_style').filter(s=>s.val!=='Unknown'),'avgCtr','val','Visual Style CTR',i=>i.avgCtr>2.3?'var(--g)':i.avgCtr>1.8?'var(--y)':'var(--r)')}</div></div>
    
    <div class="sec"><div class="sec-h"><h2>ü™ù Hook Type Performance</h2></div>${dimTable(ads,'hook','Hook Type',true)}</div>
    
    <div class="sec"><div class="sec-h"><h2>üò§ Emotion / Tone Performance</h2></div>
    <div class="g2">${dimTable(ads,'tone','Emotion / Tone',true)}${dimTable(ads,'narrative','Narrative / Pillar',true)}</div></div>
    
    <div class="sec"><div class="sec-h"><h2>üéôÔ∏è Voice Over & Production</h2></div>
    <div class="g2">${dimTable(ads,'vo','Voice Over',false)}${dimTable(ads,'production','Production Team',false)}</div></div>
    
    <div class="sec"><div class="sec-h"><h2>üë§ Creator Performance</h2></div>${dimTable(ads,'created_by','Created By',true)}</div>
    
    <div class="sec"><div class="sec-h"><h2>üè∑Ô∏è Offer & Pricing</h2></div>
    <div class="g2">${dimTable(ads,'offer','Offer Type',false)}${dimTable(ads,'prices','Pricing Shown',false)}</div></div>
    <div class="div"></div>
    
    <div class="sec"><div class="sec-h"><h2>üîÄ Cross-Dimensional Analysis</h2></div>${crossAnalysis(ads)}</div>
    <div class="div"></div>
    
    <div class="sec"><div class="sec-h"><h2>üèÖ Individual Ad Leaderboard</h2></div>${topBottom(ads)}</div>
    <div class="div"></div>
    
    <div class="sec"><div class="sec-h"><h2>üí∏ Spend Efficiency Flags</h2></div>${spendFlags(ads)}</div>
    <div class="div"></div>
    
    <div class="sec"><div class="sec-h"><h2>üìã Full Ad Explorer (${ads.length} ads)</h2></div>${fullTable(ads)}</div>
    <div class="div"></div>
    
    <div class="sec">${costPlaybook(ads)}</div>
    
    <div style="text-align:center;padding:24px;color:var(--tx3);font-size:11px">Meta Ads Command Center ¬∑ ${DATA.ads.length} creatives ¬∑ All values INR ¬∑ Last fetched: ${new Date().toLocaleString()}</div>
  `;
  
  document.getElementById('fp').addEventListener('change',e=>{curProd=e.target.value;render()});
  document.getElementById('ff').addEventListener('change',e=>{curFun=e.target.value;render()});
}

initDashboard();
</script>
</body>
</html>